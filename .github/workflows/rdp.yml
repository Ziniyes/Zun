cat > /mnt/user-data/outputs/rdp.yml << 'ENDOFFILE'
name: ğŸš€ ZENOT CLOUD - AUTO DEPLOY RDP

on:
  workflow_dispatch:
    inputs:
      server_id:
        description: 'Server ID tá»« Firebase'
        required: true
      admin_password:
        description: 'Admin Password'
        required: true

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: ğŸ¯ Khá»Ÿi Ä‘á»™ng
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘     ğŸš€ ZENOT CLOUD - RDP DEPLOYMENT       â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

      - name: ğŸ”“ Táº¯t chÃ­nh sÃ¡ch máº­t kháº©u
        run: |
          Write-Host "ğŸ”“ Táº¯t chÃ­nh sÃ¡ch máº­t kháº©u..." -ForegroundColor Blue
          secedit /export /cfg "$env:TEMP\secpol.cfg" | Out-Null
          (Get-Content "$env:TEMP\secpol.cfg") -replace "PasswordComplexity = 1", "PasswordComplexity = 0" | Set-Content "$env:TEMP\secpol_new.cfg"
          secedit /configure /db c:\windows\security\local.sdb /cfg "$env:TEMP\secpol_new.cfg" /areas SECURITYPOLICY | Out-Null
          Remove-Item "$env:TEMP\secpol*.cfg" -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… ÄÃ£ táº¯t" -ForegroundColor Green

      - name: ğŸ” Cáº¥u hÃ¬nh RDP
        run: |
          Write-Host "ğŸ›¡ï¸ Cáº¥u hÃ¬nh RDP..." -ForegroundColor Blue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389 | Out-Null
          Set-Service TermService -StartupType Automatic
          Start-Service TermService
          Write-Host "âœ… RDP Ä‘Ã£ kÃ­ch hoáº¡t" -ForegroundColor Green

      - name: ğŸ‘¤ Táº¡o Administrator
        run: |
          Write-Host "ğŸ‘¤ Táº¡o Administrator..." -ForegroundColor Blue
          $pass = ConvertTo-SecureString "${{ github.event.inputs.admin_password }}" -AsPlainText -Force
          $admin = Get-LocalUser -Name "Administrator" -ErrorAction SilentlyContinue
          
          if ($admin) {
              Set-LocalUser -Name "Administrator" -Password $pass -PasswordNeverExpires $true
              Enable-LocalUser -Name "Administrator"
          } else {
              New-LocalUser -Name "Administrator" -Password $pass -PasswordNeverExpires -AccountNeverExpires | Out-Null
              Add-LocalGroupMember -Group "Administrators" -Member "Administrator" -ErrorAction SilentlyContinue
          }
          
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Administrator" -ErrorAction SilentlyContinue
          Write-Host "âœ… User: Administrator | Pass: ${{ github.event.inputs.admin_password }}" -ForegroundColor Cyan

      - name: ğŸ§¹ Dá»n desktop
        run: |
          Write-Host "ğŸ§¹ Dá»n desktop..." -ForegroundColor Blue
          $desktops = @("C:\Users\Administrator\Desktop", "C:\Users\Public\Desktop", "$env:PUBLIC\Desktop")
          foreach($desktop in $desktops) {
              if (Test-Path $desktop) {
                  Get-ChildItem -Path $desktop -File -ErrorAction SilentlyContinue | ForEach-Object {
                      if ($_.Name -notmatch 'chrome|Chrome') {
                          Remove-Item $_.FullName -Force -ErrorAction SilentlyContinue
                      }
                  }
              }
          }
          Write-Host "âœ… ÄÃ£ dá»n" -ForegroundColor Green

      - name: ğŸ“¥ CÃ i Kami Tunnel
        run: |
          Write-Host "ğŸ“¥ Táº£i Kami Tunnel..." -ForegroundColor Blue
          $url = "https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz"
          $tarFile = "$env:TEMP\kami-tunnel.tar.gz"
          Invoke-WebRequest -Uri $url -OutFile $tarFile -UseBasicParsing
          tar -xzf $tarFile -C $env:TEMP
          Write-Host "âœ… ÄÃ£ táº£i" -ForegroundColor Green

      - name: ğŸŒ Khá»Ÿi Ä‘á»™ng Kami Tunnel
        run: |
          Write-Host "ğŸŒ Khá»Ÿi Ä‘á»™ng tunnel..." -ForegroundColor Blue
          $kamiExe = "$env:TEMP\kami-tunnel.exe"
          
          if (Test-Path $kamiExe) {
              $process = Start-Process -FilePath $kamiExe -ArgumentList "3389" -WindowStyle Hidden -PassThru -RedirectStandardOutput "$env:TEMP\tunnel-output.txt"
              
              Write-Host "â³ Äá»£i tunnel..." -ForegroundColor Yellow
              Start-Sleep -Seconds 30
              
              $output = Get-Content "$env:TEMP\tunnel-output.txt" -ErrorAction SilentlyContinue
              $publicURL = if ($output) { $output | Select-String -Pattern "http" | Select-Object -First 1 } else { "Äang láº¥y..." }
              
              Write-Host "âœ… Tunnel: $publicURL" -ForegroundColor Cyan
              echo "PUBLIC_URL=$publicURL" >> $env:GITHUB_ENV
          }

      - name: ğŸŒ Láº¥y IP Public
        run: |
          Write-Host "ğŸŒ Láº¥y IP..." -ForegroundColor Blue
          $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 5).Trim()
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          Write-Host "âœ… IP: $publicIP" -ForegroundColor Green

      - name: ğŸ“Š ThÃ´ng tin
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘          âœ… SERVER Sáº´N SÃ€NG!              â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘  ğŸ†” Server: ${{ github.event.inputs.server_id }}" -ForegroundColor White
          Write-Host "â•‘  ğŸŒ IP: $env:PUBLIC_IP" -ForegroundColor White
          Write-Host "â•‘  ğŸŒ URL: $env:PUBLIC_URL" -ForegroundColor White
          Write-Host "â•‘  ğŸ‘¤ User: Administrator" -ForegroundColor White
          Write-Host "â•‘  ğŸ”‘ Pass: ${{ github.event.inputs.admin_password }}" -ForegroundColor White
          Write-Host "â•‘  â° Duration: 6 giá»" -ForegroundColor White
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green

      - name: â³ Duy trÃ¬ 6 giá»
        run: |
          $endTime = (Get-Date).AddHours(6)
          Write-Host "ğŸ”„ Server Ä‘ang cháº¡y..." -ForegroundColor Cyan
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $h = [math]::Floor($remaining.TotalHours)
              $m = [math]::Floor($remaining.TotalMinutes % 60)
              $s = [math]::Floor($remaining.TotalSeconds % 60)
              
              Write-Host "`râ³ CÃ²n: ${h}h ${m}m ${s}s  " -NoNewline -ForegroundColor Green
              
              $rdp = Get-Service TermService -ErrorAction SilentlyContinue
              if ($rdp.Status -ne 'Running') {
                  Start-Service TermService -ErrorAction SilentlyContinue
              }
              
              Start-Sleep -Seconds 10
          }
          
          Write-Host ""
          Write-Host "â¹ï¸  Háº¾T GIá»œ!" -ForegroundColor Red

      - name: ğŸ§¹ Dá»n dáº¹p
        if: always()
        run: |
          Write-Host "ğŸ§¹ Dá»n dáº¹p..." -ForegroundColor Yellow
          Get-Process kami-tunnel -ErrorAction SilentlyContinue | Stop-Process -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
          Stop-Service TermService -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… Xong!" -ForegroundColor Green
ENDOFFILE
echo "âœ… File rdp.yml Ä‘Ã£ táº¡o"
