name: ðŸš€ ZENOT CLOUD - AUTO DEPLOY RDP

on:
  workflow_dispatch:
    inputs:
      server_id:
        description: 'Server ID tá»« Firebase'
        required: true
        type: string

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸŽ¯ Khá»Ÿi Ä‘á»™ng
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘     ðŸš€ ZENOT CLOUD - RDP DEPLOYMENT       â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ðŸ†” Server ID: ${{ github.event.inputs.server_id }}" -ForegroundColor Yellow

      - name: ðŸ”“ Táº¯t chÃ­nh sÃ¡ch máº­t kháº©u
        run: |
          Write-Host "ðŸ”“ Táº¯t chÃ­nh sÃ¡ch máº­t kháº©u..." -ForegroundColor Blue
          secedit /export /cfg "$env:TEMP\secpol.cfg" | Out-Null
          (Get-Content "$env:TEMP\secpol.cfg") -replace "PasswordComplexity = 1", "PasswordComplexity = 0" | Set-Content "$env:TEMP\secpol_new.cfg"
          secedit /configure /db c:\windows\security\local.sdb /cfg "$env:TEMP\secpol_new.cfg" /areas SECURITYPOLICY | Out-Null
          Remove-Item "$env:TEMP\secpol*.cfg" -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… ÄÃ£ táº¯t chÃ­nh sÃ¡ch" -ForegroundColor Green

      - name: ðŸ‘¤ Táº¡o máº­t kháº©u Administrator
        id: create-password
        run: |
          Write-Host "ðŸ”‘ Táº¡o máº­t kháº©u..." -ForegroundColor Blue
          
          # Táº¡o máº­t kháº©u ngáº«u nhiÃªn
          $randomPart = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 6 | ForEach-Object {[char]$_})
          $adminPassword = "Admin-$randomPart"
          
          Write-Host "âœ… Password: $adminPassword" -ForegroundColor Green
          echo "ADMIN_PASSWORD=$adminPassword" >> $env:GITHUB_ENV
          echo "admin_password=$adminPassword" >> $env:GITHUB_OUTPUT

      - name: ðŸ” Cáº¥u hÃ¬nh RDP
        run: |
          Write-Host "ðŸ›¡ï¸ Cáº¥u hÃ¬nh RDP..." -ForegroundColor Blue
          
          # Báº­t RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Firewall
          netsh advfirewall firewall add rule name="RDP-In" dir=in action=allow protocol=TCP localport=3389 | Out-Null
          netsh advfirewall firewall add rule name="RDP-Out" dir=out action=allow protocol=TCP localport=3389 | Out-Null
          
          # Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥
          Set-Service TermService -StartupType Automatic
          Set-Service UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service TermService
          Start-Service UmRdpService -ErrorAction SilentlyContinue
          
          Write-Host "âœ… RDP Ä‘Ã£ kÃ­ch hoáº¡t" -ForegroundColor Green

      - name: ðŸ”§ Cáº¥u hÃ¬nh tÃ i khoáº£n Administrator
        run: |
          Write-Host "ðŸ‘¤ Cáº¥u hÃ¬nh Administrator..." -ForegroundColor Blue
          
          $pass = ConvertTo-SecureString $env:ADMIN_PASSWORD -AsPlainText -Force
          
          # Kiá»ƒm tra vÃ  táº¡o/cáº­p nháº­t user
          $admin = Get-LocalUser -Name "Administrator" -ErrorAction SilentlyContinue
          
          if ($admin) {
              Set-LocalUser -Name "Administrator" -Password $pass -PasswordNeverExpires $true
              Enable-LocalUser -Name "Administrator"
              Write-Host "âœ… ÄÃ£ cáº­p nháº­t Administrator" -ForegroundColor Green
          } else {
              New-LocalUser -Name "Administrator" -Password $pass -PasswordNeverExpires -AccountNeverExpires -Description "RDP Admin" | Out-Null
              Write-Host "âœ… ÄÃ£ táº¡o Administrator" -ForegroundColor Green
          }
          
          # ThÃªm vÃ o nhÃ³m
          Add-LocalGroupMember -Group "Administrators" -Member "Administrator" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Administrator" -ErrorAction SilentlyContinue
          
          Write-Host "âœ… User: Administrator | Pass: $env:ADMIN_PASSWORD" -ForegroundColor Cyan

      - name: ðŸ§¹ Dá»n desktop (chá»‰ giá»¯ Chrome)
        run: |
          Write-Host "ðŸ§¹ Dá»n dáº¹p desktop..." -ForegroundColor Blue
          
          $desktops = @(
              "C:\Users\Administrator\Desktop",
              "C:\Users\Public\Desktop",
              "$env:PUBLIC\Desktop"
          )
          
          foreach($desktop in $desktops) {
              if (Test-Path $desktop) {
                  Get-ChildItem -Path $desktop -File -ErrorAction SilentlyContinue | ForEach-Object {
                      if ($_.Name -notmatch 'chrome|Chrome') {
                          Remove-Item $_.FullName -Force -ErrorAction SilentlyContinue
                      }
                  }
              }
          }
          
          Write-Host "âœ… Desktop Ä‘Ã£ sáº¡ch" -ForegroundColor Green

      - name: ðŸ“¥ Táº£i Kami Tunnel
        run: |
          Write-Host "ðŸ“¥ Táº£i Kami Tunnel..." -ForegroundColor Blue
          
          $url = "https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz"
          $tarFile = "$env:TEMP\kami-tunnel.tar.gz"
          
          # Táº£i file
          Invoke-WebRequest -Uri $url -OutFile $tarFile -UseBasicParsing
          
          # Giáº£i nÃ©n
          tar -xzf $tarFile -C $env:TEMP
          
          # Kiá»ƒm tra file
          if (Test-Path "$env:TEMP\kami-tunnel.exe") {
              Write-Host "âœ… ÄÃ£ táº£i Kami Tunnel" -ForegroundColor Green
          } else {
              Write-Host "âŒ KhÃ´ng tÃ¬m tháº¥y kami-tunnel.exe" -ForegroundColor Red
              exit 1
          }

      - name: ðŸŒ Khá»Ÿi Ä‘á»™ng Kami Tunnel
        id: start-tunnel
        run: |
          Write-Host "ðŸŒ Khá»Ÿi Ä‘á»™ng Kami Tunnel..." -ForegroundColor Blue
          
          $kamiExe = "$env:TEMP\kami-tunnel.exe"
          $logFile = "$env:TEMP\kami-output.txt"
          
          # Khá»Ÿi Ä‘á»™ng Kami Tunnel vá»›i output redirect
          $process = Start-Process -FilePath $kamiExe -ArgumentList "3389" -NoNewWindow -PassThru -RedirectStandardOutput $logFile -RedirectStandardError "$env:TEMP\kami-error.txt"
          
          Write-Host "â³ Äá»£i tunnel khá»Ÿi Ä‘á»™ng..." -ForegroundColor Yellow
          Start-Sleep -Seconds 45
          
          # Äá»c output Ä‘á»ƒ láº¥y IP:PORT
          $tunnelURL = ""
          $maxRetries = 20
          
          for ($i = 1; $i -le $maxRetries; $i++) {
              if (Test-Path $logFile) {
                  $output = Get-Content $logFile -ErrorAction SilentlyContinue
                  
                  # TÃ¬m dÃ²ng chá»©a URL hoáº·c IP:PORT
                  $urlLine = $output | Select-String -Pattern "http|tcp|:(\d+)" | Select-Object -First 1
                  
                  if ($urlLine) {
                      $tunnelURL = $urlLine.Line.Trim()
                      
                      # Parse IP:PORT
                      if ($tunnelURL -match '(\d+\.\d+\.\d+\.\d+):(\d+)') {
                          $tunnelIP = $matches[1]
                          $tunnelPort = $matches[2]
                          Write-Host "âœ… Tunnel IP: $tunnelIP" -ForegroundColor Green
                          Write-Host "âœ… Tunnel Port: $tunnelPort" -ForegroundColor Green
                          
                          echo "TUNNEL_IP=$tunnelIP" >> $env:GITHUB_ENV
                          echo "TUNNEL_PORT=$tunnelPort" >> $env:GITHUB_ENV
                          echo "TUNNEL_URL=$tunnelIP`:$tunnelPort" >> $env:GITHUB_ENV
                          
                          echo "tunnel_ip=$tunnelIP" >> $env:GITHUB_OUTPUT
                          echo "tunnel_port=$tunnelPort" >> $env:GITHUB_OUTPUT
                          echo "tunnel_url=$tunnelIP`:$tunnelPort" >> $env:GITHUB_OUTPUT
                          
                          break
                      }
                      # Náº¿u lÃ  HTTP URL
                      elseif ($tunnelURL -match 'http://([^:]+):(\d+)') {
                          $tunnelIP = $matches[1]
                          $tunnelPort = $matches[2]
                          Write-Host "âœ… Tunnel URL: $tunnelURL" -ForegroundColor Green
                          
                          echo "TUNNEL_IP=$tunnelIP" >> $env:GITHUB_ENV
                          echo "TUNNEL_PORT=$tunnelPort" >> $env:GITHUB_ENV
                          echo "TUNNEL_URL=$tunnelIP`:$tunnelPort" >> $env:GITHUB_ENV
                          
                          echo "tunnel_ip=$tunnelIP" >> $env:GITHUB_OUTPUT
                          echo "tunnel_port=$tunnelPort" >> $env:GITHUB_OUTPUT
                          echo "tunnel_url=$tunnelIP`:$tunnelPort" >> $env:GITHUB_OUTPUT
                          
                          break
                      }
                  }
              }
              
              Write-Host "â³ Thá»­ láº¥y URL láº§n $i/$maxRetries..." -ForegroundColor Yellow
              Start-Sleep -Seconds 3
          }
          
          # Náº¿u khÃ´ng láº¥y Ä‘Æ°á»£c, hiá»ƒn thá»‹ log
          if (-not $tunnelURL) {
              Write-Host "âš ï¸ KhÃ´ng tÃ¬m tháº¥y tunnel URL trong log" -ForegroundColor Yellow
              Write-Host "ðŸ“‹ Log output:" -ForegroundColor Blue
              if (Test-Path $logFile) {
                  Get-Content $logFile
              }
              Write-Host "ðŸ“‹ Error output:" -ForegroundColor Blue
              if (Test-Path "$env:TEMP\kami-error.txt") {
                  Get-Content "$env:TEMP\kami-error.txt"
              }
              
              # Set giÃ¡ trá»‹ máº·c Ä‘á»‹nh
              echo "TUNNEL_URL=Äang láº¥y..." >> $env:GITHUB_ENV
              echo "tunnel_url=Äang láº¥y..." >> $env:GITHUB_OUTPUT
          }

      - name: ðŸŒ Láº¥y IP Public (dá»± phÃ²ng)
        run: |
          Write-Host "ðŸŒ Láº¥y IP Public..." -ForegroundColor Blue
          
          try {
              $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 5).Trim()
              echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
              Write-Host "âœ… IP Public: $publicIP" -ForegroundColor Green
          } catch {
              echo "PUBLIC_IP=N/A" >> $env:GITHUB_ENV
              Write-Host "âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c IP Public" -ForegroundColor Yellow
          }

      - name: ðŸ“¡ Cáº­p nháº­t Firebase
        env:
          FIREBASE_URL: https://proxy-62231-default-rtdb.asia-southeast1.firebasedatabase.app
        run: |
          Write-Host "ðŸ“¡ Cáº­p nháº­t thÃ´ng tin lÃªn Firebase..." -ForegroundColor Blue
          
          $serverId = "${{ github.event.inputs.server_id }}"
          $firebaseUrl = "$env:FIREBASE_URL/servers/$serverId.json"
          
          # Táº¡o JSON data
          $updateData = @{
              status = "running"
              publicIP = if ($env:TUNNEL_IP) { $env:TUNNEL_IP } else { $env:PUBLIC_IP }
              publicURL = if ($env:TUNNEL_URL) { $env:TUNNEL_URL } else { "$($env:PUBLIC_IP):3389" }
              rdpPort = if ($env:TUNNEL_PORT) { $env:TUNNEL_PORT } else { "3389" }
              adminPassword = $env:ADMIN_PASSWORD
              lastUpdate = [DateTimeOffset]::UtcNow.ToUnixTimeMilliseconds()
          } | ConvertTo-Json -Compress
          
          try {
              # Update Firebase (khÃ´ng cáº§n auth token cho public database)
              $response = Invoke-RestMethod -Uri $firebaseUrl -Method PATCH -Body $updateData -ContentType "application/json"
              Write-Host "âœ… ÄÃ£ cáº­p nháº­t Firebase" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸ Lá»—i cáº­p nháº­t Firebase: $($_.Exception.Message)" -ForegroundColor Yellow
              Write-Host "ðŸ“‹ URL: $firebaseUrl" -ForegroundColor Blue
              Write-Host "ðŸ“‹ Data: $updateData" -ForegroundColor Blue
          }

      - name: ðŸ“Š ThÃ´ng tin káº¿t ná»‘i
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘          âœ… SERVER Sáº´N SÃ€NG!              â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘  ðŸ†” Server ID: ${{ github.event.inputs.server_id }}" -ForegroundColor White
          Write-Host "â•‘  ðŸŒ Tunnel URL: $env:TUNNEL_URL" -ForegroundColor White
          Write-Host "â•‘  ðŸŒ IP Public: $env:PUBLIC_IP" -ForegroundColor White
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘" -ForegroundColor DarkGray
          Write-Host "â•‘  ðŸ‘¤ Username: Administrator" -ForegroundColor Cyan
          Write-Host "â•‘  ðŸ”‘ Password: $env:ADMIN_PASSWORD" -ForegroundColor Cyan
          Write-Host "â•‘  ðŸšª Port: $env:TUNNEL_PORT" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘" -ForegroundColor DarkGray
          Write-Host "â•‘  â° Thá»i lÆ°á»£ng: 6 giá»" -ForegroundColor Yellow
          Write-Host "â•‘  ðŸ• Báº¯t Ä‘áº§u: $((Get-Date).ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor Yellow
          Write-Host "â•‘  ðŸ• Káº¿t thÃºc: $((Get-Date).AddHours(6).ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor Yellow
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘  ðŸ“Œ CÃCH Káº¾T Ná»I:                          â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  1ï¸âƒ£  Má»Ÿ Remote Desktop (mstsc)             â•‘" -ForegroundColor White
          Write-Host "â•‘  2ï¸âƒ£  Nháº­p: $env:TUNNEL_URL                â•‘" -ForegroundColor White
          Write-Host "â•‘  3ï¸âƒ£  User: Administrator                   â•‘" -ForegroundColor White
          Write-Host "â•‘  4ï¸âƒ£  Pass: $env:ADMIN_PASSWORD            â•‘" -ForegroundColor White
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""

      - name: â³ Duy trÃ¬ server (6 giá»)
        run: |
          $endTime = (Get-Date).AddHours(6)
          
          Write-Host "ðŸ”„ Server Ä‘ang cháº¡y..." -ForegroundColor Cyan
          Write-Host "ðŸŒ Káº¿t ná»‘i: $env:TUNNEL_URL" -ForegroundColor Yellow
          Write-Host "â° Káº¿t thÃºc: $($endTime.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor Yellow
          Write-Host ""
          
          $checkCount = 0
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $h = [math]::Floor($remaining.TotalHours)
              $m = [math]::Floor($remaining.TotalMinutes % 60)
              $s = [math]::Floor($remaining.TotalSeconds % 60)
              
              Write-Host "`râ³ CÃ²n láº¡i: ${h}h ${m}m ${s}s | RDP: " -NoNewline -ForegroundColor Green
              
              # Kiá»ƒm tra dá»‹ch vá»¥ RDP má»—i 60 giÃ¢y
              $checkCount++
              if ($checkCount % 6 -eq 0) {
                  $rdp = Get-Service TermService -ErrorAction SilentlyContinue
                  if ($rdp.Status -ne 'Running') {
                      Write-Host "âš ï¸  Khá»Ÿi Ä‘á»™ng láº¡i RDP..." -ForegroundColor Yellow
                      Start-Service TermService -ErrorAction SilentlyContinue
                  } else {
                      Write-Host "OK" -NoNewline -ForegroundColor Green
                  }
                  
                  # Kiá»ƒm tra Kami Tunnel
                  $kamiProcess = Get-Process kami-tunnel -ErrorAction SilentlyContinue
                  if (-not $kamiProcess) {
                      Write-Host " | Tunnel: âš ï¸  ÄÃ£ dá»«ng!" -NoNewline -ForegroundColor Red
                  } else {
                      Write-Host " | Tunnel: OK" -NoNewline -ForegroundColor Green
                  }
              }
              
              Start-Sleep -Seconds 10
          }
          
          Write-Host ""
          Write-Host ""
          Write-Host "â¹ï¸  Háº¾T THá»œI GIAN - SERVER Tá»° Äá»˜NG ÄÃ“NG!" -ForegroundColor Red

      - name: ðŸ“¡ Cáº­p nháº­t tráº¡ng thÃ¡i háº¿t háº¡n
        if: always()
        env:
          FIREBASE_URL: https://proxy-62231-default-rtdb.asia-southeast1.firebasedatabase.app
        run: |
          Write-Host "ðŸ“¡ Cáº­p nháº­t tráº¡ng thÃ¡i..." -ForegroundColor Blue
          
          $serverId = "${{ github.event.inputs.server_id }}"
          $firebaseUrl = "$env:FIREBASE_URL/servers/$serverId.json"
          
          $updateData = @{
              status = "expired"
              lastUpdate = [DateTimeOffset]::UtcNow.ToUnixTimeMilliseconds()
          } | ConvertTo-Json -Compress
          
          try {
              Invoke-RestMethod -Uri $firebaseUrl -Method PATCH -Body $updateData -ContentType "application/json" | Out-Null
              Write-Host "âœ… ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i expired" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸ KhÃ´ng thá»ƒ cáº­p nháº­t: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: ðŸ§¹ Dá»n dáº¹p
        if: always()
        run: |
          Write-Host "ðŸ§¹ Dá»n dáº¹p há»‡ thá»‘ng..." -ForegroundColor Yellow
          
          # Dá»«ng Kami Tunnel
          Get-Process kami-tunnel -ErrorAction SilentlyContinue | Stop-Process -Force
          
          # Táº¯t RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
          Stop-Service TermService -Force -ErrorAction SilentlyContinue
          
          # XÃ³a firewall rules
          netsh advfirewall firewall delete rule name="RDP-In" 2>$null | Out-Null
          netsh advfirewall firewall delete rule name="RDP-Out" 2>$null | Out-Null
          
          # XÃ³a file
          Remove-Item "$env:TEMP\kami-*" -Force -ErrorAction SilentlyContinue
          
          Write-Host "âœ… HoÃ n táº¥t! Háº¹n gáº·p láº¡i! ðŸ‘‹" -ForegroundColor Green
